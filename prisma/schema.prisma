generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "sqlite"
  url       = "file:./data.db"
}

model Extract {
  id            String            @id @default(cuid())
  title         String
  content       String?
  notes         String?
  sourceUrl     String?
  michelinStars Int               @default(0)
  formatId      String?
  parentId      String?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  publishedOn   DateTime?
  childOrder    Int               @default(0)
  attachments   Attachment[]
  format        ExtractFormat?    @relation(fields: [formatId], references: [id])
  parent        Extract?          @relation("ParentChild", fields: [parentId], references: [id])
  children      Extract[]         @relation("ParentChild")
  connectedFrom ExtractRelation[] @relation("target")
  connectedTo   ExtractRelation[] @relation("source")
  creators      Creator[]         @relation("ExtractCreators")
  spaces        Space[]           @relation("ExtractSpaces")

  // Basic indexes
  @@index([createdAt])
  @@index([updatedAt])
  @@index([publishedOn])
  // Composite indexes for common queries
  @@index([publishedOn, createdAt]) // For ordering and filtering
  @@index([parentId, childOrder]) // For ordering children
}

model ExtractRelation {
  fromId     String
  toId       String
  annotation String?
  from       Extract @relation("source", fields: [fromId], references: [id])
  to         Extract @relation("target", fields: [toId], references: [id])

  @@id([fromId, toId])
  @@index([annotation])
}

model ExtractFormat {
  id       String    @id @default(cuid())
  name     String
  extracts Extract[]

  @@index([name])
}

model Attachment {
  id        String  @id @default(cuid())
  url       String  @default("")
  caption   String?
  altText   String?
  extractId String
  extension String  @default("")
  extract   Extract @relation(fields: [extractId], references: [id])

  @@index([extension])
}

model Creator {
  id        String    @id @default(cuid())
  name      String
  siteUrl   String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  extracts  Extract[] @relation("ExtractCreators")

  @@index([name])
  @@index([createdAt])
  @@index([updatedAt])
}

model Space {
  id          String    @id @default(cuid())
  topic       String
  title       String?
  icon        String?
  description String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  extracts    Extract[] @relation("ExtractSpaces")

  @@index([topic])
  @@index([createdAt])
  @@index([updatedAt])
}
